
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Linux tips</title>
    <link rel="shortcut icon" href="/assets/icon-512.png"/>
    <link
      rel="stylesheet"
      href="https://unpkg.com/prismjs@1.20.0/themes/prism-tomorrow.css"
    />
    <link rel="stylesheet" href="/assets/baseLayout.css" />
  </head>
  <body>
    <header class="baseLayout-headerOuter">
      <div class="ui-container baseLayout-headerInner">
        <a
          class="baseLayout-headerLink"
          href="/ja/"
          tabindex="-1"
        >
          <span class="baseLayout-siteTitle">books.ginpei.dev</span>
        </a>
        <a
          class="baseLayout-headerLink"
          href="https://github.com/ginpei/books.ginpei.dev"
          tabindex="-1"
        >
          GitHub
        </a>
      </div>
    </header>
    <article class="ui-container baseLayout-body">
      <div class="baseLayout-titleGroup">
        <h1 class="baseLayout-title">Linux tips</h1>
        <div class="baseLayout-metaLine">
          <a
            href="https://github.com/ginpei/books.ginpei.dev/commits/main/./books/ja/linux-tips/index.md"
            tabindex="-1"
          >
            
              <time>2022-07-19</time>
              (History)
            
          </a>
        </div>
      </div>
      
      <aside class="baseLayout-toc">
        <nav class="toc" >
        <ol><li><a href="#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E5%AE%B9%E9%87%8F">ディスク容量</a><ol><li><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E5%85%A8%E4%BD%93">ファイルシステム全体</a></li><li><a href="#%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%83%BC%E5%8D%98%E4%BD%8D">ディレクトリー単位</a></li></ol></li><li><a href="#%E3%82%B9%E3%83%AF%E3%83%83%E3%83%97%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%BC">スワップメモリー</a><ol><li><a href="#%E3%82%A8%E3%83%A9%E3%83%BC">エラー</a></li></ol></li><li><a href="#make-%E3%81%AE%E6%BA%96%E5%82%99">make の準備</a></li><li><a href="#vs-code-%E3%81%A7%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E7%9B%A3%E8%A6%96%E6%95%B0%E4%B8%8A%E9%99%90%E6%92%A4%E5%BB%83">VS Code でファイル監視数上限撤廃</a></li><li><a href="#%E3%83%A2%E3%83%8B%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0">モニタリング</a></li><li><a href="#https">HTTPS</a></li></ol>
      </nav>
      </aside>
      
      <p>なんか忘れがちなもの。</p>
<h2 id="%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E5%AE%B9%E9%87%8F" tabindex="-1"><a class="header-anchor" href="#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E5%AE%B9%E9%87%8F"><span>ディスク容量</span></a></h2>
<h3 id="%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E5%85%A8%E4%BD%93" tabindex="-1"><a class="header-anchor" href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E5%85%A8%E4%BD%93"><span>ファイルシステム全体</span></a></h3>
<pre><code>$ df -h
Filesystem        Size  Used Avail Use% Mounted on
devtmpfs          1.9G     0  1.9G   0% /dev
tmpfs             1.9G     0  1.9G   0% /dev/shm
tmpfs             1.9G  432K  1.9G   1% /run
tmpfs             1.9G     0  1.9G   0% /sys/fs/cgroup
/dev/nvme0n1p1    8.0G  5.3G  2.8G  66% /
/dev/nvme0n1p128   10M  3.8M  6.3M  38% /boot/efi
tmpfs             386M     0  386M   0% /run/user/1000
</code></pre>
<h3 id="%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%83%BC%E5%8D%98%E4%BD%8D" tabindex="-1"><a class="header-anchor" href="#%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%83%BC%E5%8D%98%E4%BD%8D"><span>ディレクトリー単位</span></a></h3>
<pre><code>$ du -BM -d1
2M      ./.git
169M    ./packages
408M    ./node_modules
579M    .
</code></pre>
<h2 id="%E3%82%B9%E3%83%AF%E3%83%83%E3%83%97%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%BC" tabindex="-1"><a class="header-anchor" href="#%E3%82%B9%E3%83%AF%E3%83%83%E3%83%97%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%BC"><span>スワップメモリー</span></a></h2>
<pre><code>$ sudo mkdir /swaps
$ sudo dd if=/dev/zero of=/swaps/1 bs=1M count=2048
$ sudo mkswap /swaps/1
$ sudo chmod 0600 /swaps/1
$ sudo swapon /swaps/1
</code></pre>
<p>確認。</p>
<pre><code>$ cat /proc/swaps
Filename                                Type            Size            Used            Priority
/swaps/1                                file            2097148         0               -2
</code></pre>
<p>永続化するため設定に 1 行追加。</p>
<pre><code>$ sudo vi /etc/fstab
</code></pre>
<pre><code>/swaps/1          swap                    swap    defaults        0 0
</code></pre>
<h3 id="%E3%82%A8%E3%83%A9%E3%83%BC" tabindex="-1"><a class="header-anchor" href="#%E3%82%A8%E3%83%A9%E3%83%BC"><span>エラー</span></a></h3>
<pre><code>$ sudo swapon /swaps/1
swapon: /swaps/1: swapon failed: Invalid argument
</code></pre>
<p>ファイルシステムを確認。&quot;overlay&quot; ファイルシステム（たぶん Docker）はスワップをサポートしていない。</p>
<pre><code>$ df -Th /swaps
Filesystem     Type     Size  Used Avail Use% Mounted on
overlay        overlay   32G   16G   15G  52% /
</code></pre>
<h2 id="make-%E3%81%AE%E6%BA%96%E5%82%99" tabindex="-1"><a class="header-anchor" href="#make-%E3%81%AE%E6%BA%96%E5%82%99"><span><code>make</code> の準備</span></a></h2>
<blockquote>
<p>make: g++: Command not found</p>
</blockquote>
<p>いずれかを実行。</p>
<pre><code>$ sudo apt install build-essential
</code></pre>
<pre><code>$ sudo yum groupinstall -y 'Development Tools'
</code></pre>
<h2 id="vs-code-%E3%81%A7%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E7%9B%A3%E8%A6%96%E6%95%B0%E4%B8%8A%E9%99%90%E6%92%A4%E5%BB%83" tabindex="-1"><a class="header-anchor" href="#vs-code-%E3%81%A7%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E7%9B%A3%E8%A6%96%E6%95%B0%E4%B8%8A%E9%99%90%E6%92%A4%E5%BB%83"><span>VS Code でファイル監視数上限撤廃</span></a></h2>
<ul>
<li><a href="https://code.visualstudio.com/docs/setup/linux#_visual-studio-code-is-unable-to-watch-for-file-changes-in-this-large-workspace-error-enospc">https://code.visualstudio.com/docs/setup/linux#_visual-studio-code-is-unable-to-watch-for-file-changes-in-this-large-workspace-error-enospc</a></li>
</ul>
<p>ポップアップでこんなエラーが出てくるかも。
あるいはコンソール。</p>
<blockquote>
<p>Warning: ENOSPC: System limit for number of file watchers reached, watch '/path/to/files/'</p>
</blockquote>
<p>リンク先の指示に従い作業する。</p>
<pre><code>$ cat /proc/sys/fs/inotify/max_user_watches
$ sudo vi /etc/sysctl.conf
</code></pre>
<pre><code>fs.inotify.max_user_watches=524288
</code></pre>
<pre><code>$ sudo sysctl -p
</code></pre>
<h2 id="%E3%83%A2%E3%83%8B%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0" tabindex="-1"><a class="header-anchor" href="#%E3%83%A2%E3%83%8B%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0"><span>モニタリング</span></a></h2>
<p>CPU やメモリーの利用状況が見える。
<code>top</code> より格好良い。</p>
<pre><code>$ sudo yum install htop -y
$ htop
</code></pre>
<p><code>q</code> を押すと終了。</p>
<h2 id="https" tabindex="-1"><a class="header-anchor" href="#https"><span>HTTPS</span></a></h2>
<ul>
<li><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/SSL-on-amazon-linux-2.html#letsencrypt">Tutorial: Configure SSL/TLS on Amazon Linux 2 - Amazon Elastic Compute Cloud</a></li>
</ul>
<ol>
<li>HTTP 用ポート (80) を開いておく</li>
<li>certbot をインストール</li>
<li>キーを取得</li>
</ol>
<pre><code>$ cd ~
$ sudo wget -r --no-parent -A 'epel-release-*.rpm' https://dl.fedoraproject.org/pub/epel/7/x86_64/Packages/e/
$ sudo rpm -Uvh dl.fedoraproject.org/pub/epel/7/x86_64/Packages/e/epel-release-*.rpm
$ sudo yum-config-manager --enable epel*
$ sudo yum repolist all
$ sudo yum install -y certbot
$ sudo certbot certonly --register-unsafely-without-email -- standalone -d xxx.example.com
</code></pre>
<p><code>certbot</code> のオプション <code>--register-unsafely-without-email</code> は開発用。本番では使用しない。</p>
<p>出てくるファイルの例：</p>
<pre><code>$ sudo ls -l /etc/letsencrypt/live/xxx.example.com/
total 4
lrwxrwxrwx 1 root root  38 Dec  4 21:29 cert.pem -&gt; ../../archive/xxx.example.com/cert1.pem
lrwxrwxrwx 1 root root  39 Dec  4 21:29 chain.pem -&gt; ../../archive/xxx.example.com/chain1.pem
lrwxrwxrwx 1 root root  43 Dec  4 21:29 fullchain.pem -&gt; ../../archive/xxx.example.com/fullchain1.pem
lrwxrwxrwx 1 root root  41 Dec  4 21:29 privkey.pem -&gt; ../../archive/xxx.example.com/privkey1.pem
-rw-r--r-- 1 root root 692 Dec  4 21:29 README
</code></pre>
<p>実装例。</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token number">8080</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// you have to copy these 2 files and set permission</span>
<span class="token keyword">const</span> httpsOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">cert</span><span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'keys/cert.pem'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'keys/privkey.pem'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> https<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>httpsOptions<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Port: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

    </article>
    <footer class="baseLayout-footer">
      <div class="ui-container">
        <p><a href="/ja/">Home</a></p>
      </div>
    </footer>
  </body>
</html>
