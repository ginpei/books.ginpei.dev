
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitHub Actions で GitHub Pages へ公開する</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/prismjs@1.20.0/themes/prism-tomorrow.css"
    />
    <link rel="stylesheet" href="/assets/base.css" />
  </head>
  <body>
    <header class="baseLayout-headerOuter">
      <div class="ui-container baseLayout-headerInner">
        <a
          class="baseLayout-headerLink"
          href="/ja/"
        >
          <span class="baseLayout-siteTitle">books.ginpei.dev</span>
        </a>
        <a
          class="baseLayout-headerLink"
          href="https://github.com/ginpei/books.ginpei.dev"
        >
          GitHub
        </a>
      </div>
    </header>
    <article class="ui-container baseLayout-body">
      <div class="baseLayout-titleGroup">
        <h1 class="baseLayout-title">GitHub Actions で GitHub Pages へ公開する</h1>
        <div class="baseLayout-metaLine">
          <a href="https://github.com/ginpei/books.ginpei.dev/commits/main/./books/ja/github-actions-publish-pages/index.md">History</a>
          
          <span>
            Updated at <time>2021-05-21</time>
          </span>
          
        </div>
      </div>
      <p>この GitHub Actions を使う。</p>
<ul>
<li><a href="https://github.com/marketplace/actions/github-pages-action">GitHub Pages action · Actions · GitHub Marketplace</a></li>
</ul>
<h2>方針</h2>
<ul>
<li>ジェネレーターは <a href="../eleventy/">Eleventy</a>
<ul>
<li>そうでなければ適宜読み替えてください</li>
</ul>
</li>
<li><code>books/</code> ディレクトリーに Markdown ファイル等のコンテンツが置かれる</li>
<li><code>main</code> ブランチへの <a href="https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#push"><code>git push</code></a> で公開</li>
</ul>
<h2>作業手順</h2>
<ol>
<li>ビルドスクリプト (<code>npm run build</code>)</li>
<li>GitHub Actions のセットアップ</li>
<li>リポジトリーの GitHub Pages 設定</li>
<li>独自ドメインの設定（必要なら）</li>
</ol>
<h3>ビルドスクリプト (<code>npm run build</code>)</h3>
<p><code>package.json</code> で npm script <code>build</code> を用意する。</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"eleventy --input=books/ --formats=html,md,css,png"</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>…</code></pre>
<p>これで <code>npm run build</code> が使えるようになった。</p>
<h3>GitHub Actions のセットアップ</h3>
<p>プロジェクトのディレクトリーに <code>.github/workflows/github-pages.yml</code> を以下の内容で作成。</p>
<pre class="language-yml"><code class="language-yml"><span class="token key atrule">name</span><span class="token punctuation">:</span> GitHub Pages<br><br><span class="token key atrule">on</span><span class="token punctuation">:</span> push<br><br><span class="token key atrule">jobs</span><span class="token punctuation">:</span><br>  <span class="token key atrule">publish</span><span class="token punctuation">:</span><br>    <span class="token key atrule">if</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> github.ref == 'refs/heads/main' <span class="token punctuation">}</span><span class="token punctuation">}</span><br>    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span><span class="token number">20.04</span><br>    <span class="token key atrule">permissions</span><span class="token punctuation">:</span><br>      <span class="token key atrule">contents</span><span class="token punctuation">:</span> write<br>    <span class="token key atrule">concurrency</span><span class="token punctuation">:</span><br>      <span class="token key atrule">group</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> github.workflow <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>$<span class="token punctuation">{</span><span class="token punctuation">{</span> github.ref <span class="token punctuation">}</span><span class="token punctuation">}</span><br>    <span class="token key atrule">steps</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v3<br>        <span class="token key atrule">with</span><span class="token punctuation">:</span><br>          <span class="token key atrule">fetch-depth</span><span class="token punctuation">:</span> <span class="token number">0</span><br><br>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Use Node.js<br>        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v3<br>        <span class="token key atrule">with</span><span class="token punctuation">:</span><br>          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token number">18</span><br>          <span class="token key atrule">cache</span><span class="token punctuation">:</span> <span class="token string">"npm"</span><br><br>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install<br>        <span class="token key atrule">run</span><span class="token punctuation">:</span> npm ci<br><br>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build<br>        <span class="token key atrule">run</span><span class="token punctuation">:</span> npm run build<br><br>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Deploy<br>        <span class="token key atrule">uses</span><span class="token punctuation">:</span> peaceiris/actions<span class="token punctuation">-</span>gh<span class="token punctuation">-</span>pages@v3<br>        <span class="token key atrule">with</span><span class="token punctuation">:</span><br>          <span class="token key atrule">github_token</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GITHUB_TOKEN <span class="token punctuation">}</span><span class="token punctuation">}</span><br>          <span class="token key atrule">publish_dir</span><span class="token punctuation">:</span> _site/</code></pre>
<h3>リポジトリーの GitHub Pages 設定</h3>
<p>GitHub で該当リポジトリーを開いて Settings &gt; 左メニュー Pages &gt; Source にて、<code>gh-pages</code> のブランチを選択する。</p>
<p>&quot;(None)&quot; のままだと、この設定ページに &quot;Your site is ready to be published at ...&quot; というメッセージ（青色）が表示されるものの公開が完了しない。&quot;Your site is published at ...&quot; というメッセージ（緑色）になれば完了。</p>
<h3>独自ドメインの設定（必要なら）</h3>
<ul>
<li><a href="https://docs.github.com/en/pages/configuring-a-custom-domain-for-your-github-pages-site">Configuring a custom domain for your GitHub Pages site - GitHub Docs</a></li>
<li><a href="https://www.11ty.dev/docs/copy/">Passthrough File Copy — Eleventy</a></li>
</ul>
<p>いわゆる <code>CNAME</code> の設定。</p>
<p>まず利用中のドメイン管理サービスで、該当ドメインに <code>CNAME</code> で振り先が <code>&lt;GitHubアカウント名&gt;.github.io</code> 、例えば <code>ginpei</code> なら <code>ginpei.github.io</code> になるよう設定しておく。</p>
<p>次に設定ファイルを用意する。<code>static/CNAME</code> （拡張子なし）を作成し、該当ドメイン名を記述する。</p>
<pre><code>my-site.example.com
</code></pre>
<p>このファイル <code>CNAME</code> は出力ディレクトリーのルートに置かれる必要がある。Eleventy の設定 <code>.eleventy.js</code> で以下のようにして、<code>static/</code> 以下のファイルを含めるようにする。</p>
<pre class="language-js"><code class="language-js">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">eleventyConfig</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  eleventyConfig<span class="token punctuation">.</span><span class="token function">addPassthroughCopy</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token keyword">static</span><span class="token operator">:</span> <span class="token string">"/"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>…</code></pre>
<p>これでビルド時に <code>_site/CNAME</code> が用意される。GitHub Pages はこのファイルを読み DNS 設定を行う。</p>
<p>設定後には TLS 証明書が発効され、それも完了すると <code>https://</code> で利用できるようになる。割と時間がかかるっぽい。&quot;Enforce HTTPS&quot; の設定をしておくと良さそう。</p>
<h2>エラーと対策</h2>
<h3>なんか動いてない気がする</h3>
<p>GitHub で該当リポジトリーを開いて Actions からログが閲覧できる。エラーが起きていないか確認する。</p>
<h3>CSS や画像が読み込まれない</h3>
<p>Eleventy を <code>--serve</code> オプションで起動するとルート <code>/index.html</code> で動作する一方、GitHub Pages ではリポジトリー名がパスに含まれるため <code>/foo-bar/index.html</code> のようになる。</p>
<p>WIP</p>
<h2>他の GitHub Actions</h2>
<ul>
<li><a href="https://github.com/marketplace/actions/github-pages-action">GitHub Pages action · Actions · GitHub Marketplace</a> （今回利用したもの）</li>
<li><a href="https://github.com/marketplace/actions/deploy-to-github-pages">Deploy to GitHub Pages · Actions · GitHub Marketplace</a></li>
<li><a href="https://github.com/marketplace/actions/github-pages">GitHub Pages · Actions · GitHub Marketplace</a></li>
</ul>

    </article>
    <footer class="baseLayout-footer">
      <div class="ui-container">
        <p><a href="/">Home</a></p>
      </div>
    </footer>
  </body>
</html>
